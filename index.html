<!DOCTYPE html>
<html>
<head>
    <title>Qag Messenger Ultra Simple</title>
    <style>
        body { 
            font-family: Arial; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .auth-form, .chat-section { 
            background: white;
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        input, button { 
            padding: 12px; 
            margin: 5px; 
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        input { width: 250px; }
        button { 
            background: #007bff; 
            color: white; 
            border: none;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        #messages { 
            height: 300px; 
            border: 1px solid #eee; 
            overflow-y: scroll; 
            padding: 10px;
            margin: 10px 0;
            background: #fafafa;
        }
        .message { 
            margin: 10px 0; 
            padding: 8px; 
            background: #e3f2fd; 
            border-radius: 5px;
        }
        .my-message { 
            background: #e8f5e8; 
            text-align: right;
        }
        .status { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>üí¨ Qag Messenger Alpha 0.1</h1>
    
    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="auth-form" id="authSection">
        <h3>üîê –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
        <input type="text" id="usernameInput" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å">
        <br>
        <button onclick="login()">–í–æ–π—Ç–∏</button>
        <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <div id="authStatus"></div>
    </div>
    
    <!-- –ß–∞—Ç (–ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞) -->
    <div class="chat-section" id="chatSection" style="display: none;">
        <h3>‚úÖ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <span id="userName"></span></h3>
        <p>–í–∞—à ID: <span id="userIdDisplay" class="status"></span></p>
        
        <div>
            <input type="text" id="friendIdInput" placeholder="ID –¥—Ä—É–≥–∞ –¥–ª—è –æ–±—â–µ–Ω–∏—è">
            <button onclick="startChat()">–ù–∞—á–∞—Ç—å —á–∞—Ç</button>
        </div>
        
        <div id="messages"></div>
        
        <div>
            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let socket = null;
        let currentUserId = null;
        let currentUserName = null;
        let currentFriendId = null;

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
        function connectSocket() {
            socket = io();
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            socket.on('new_message', (message) => {
                displayMessage(message);
            });
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        async function register() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!username || !password) {
                showAuthStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
                return;
            }
            
            const response = await fetch('/api/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, action: 'register' })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAuthStatus(`–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–∞—à ID: ${result.userId}`, 'status');
                setTimeout(() => loginSuccess(result.userId, username), 1000);
            } else {
                showAuthStatus('–û—à–∏–±–∫–∞: ' + result.error, 'error');
            }
        }

        // –í—Ö–æ–¥
        async function login() {
            const username = document.getElementById('usernameInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!username || !password) {
                showAuthStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
                return;
            }
            
            const response = await fetch('/api/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, action: 'login' })
            });
            
            const result = await response.json();
            
            if (result.success) {
                loginSuccess(result.userId, username);
            } else {
                showAuthStatus('–û—à–∏–±–∫–∞: ' + result.error, 'error');
            }
        }

        // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
        function loginSuccess(userId, username) {
            currentUserId = userId;
            currentUserName = username;
            
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('chatSection').style.display = 'block';
            document.getElementById('userIdDisplay').textContent = userId;
            document.getElementById('userName').textContent = username;
            
            connectSocket();
            socket.emit('user_online', userId);
            
            showAuthStatus('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!', 'status');
        }

        // –ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ —Å –¥—Ä—É–≥–æ–º
        function startChat() {
            currentFriendId = document.getElementById('friendIdInput').value;
            if (!currentFriendId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞!');
                return;
            }
            document.getElementById('messages').innerHTML = '<div class="status">üí¨ –ß–∞—Ç –Ω–∞—á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ID: ' + currentFriendId + '</div>';
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function sendMessage() {
            if (!currentFriendId) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞!');
                return;
            }
            
            const text = document.getElementById('messageInput').value.trim();
            if (!text) return;
            
            const messageData = {
                fromUserId: currentUserId,
                fromUserName: currentUserName,
                toUserId: currentFriendId,
                text: text,
                timestamp: new Date().toLocaleTimeString()
            };
            
            socket.emit('send_message', messageData);
            document.getElementById('messageInput').value = '';
        }

        // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function displayMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            
            if (message.fromUserId === currentUserId) {
                messageDiv.className = 'message my-message';
                messageDiv.innerHTML = `<strong>–Ø:</strong> ${message.text} <small>(${message.timestamp})</small>`;
            } else {
                messageDiv.className = 'message';
                messageDiv.innerHTML = `<strong>${message.fromUserName}:</strong> ${message.text} <small>(${message.timestamp})</small>`;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showAuthStatus(text, type) {
            const statusDiv = document.getElementById('authStatus');
            statusDiv.textContent = text;
            statusDiv.className = type;
        }
    </script>
</body>
</html>
